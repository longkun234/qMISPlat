function CPFormSaveFormData(){CPFormGlobal_Scope.SaveFormData()}function SelectExpression_SetReturn(){var obj=$(SelectExpression_ThisObj),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldName=obj.attr("data-fieldName"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName"),sValue=CPFormGlobal_Scope.GetFieldValue(tableName,fieldName,dataTableRowIndex);sValue=sValue.replace("{}",CPShowModalDialogReturnArgs);CPFormGlobal_Scope.SetFieldValue(tableName,fieldName,dataTableRowIndex,sValue)}function SelectExpression(thisObj,nType){var sValue=$(thisObj).val();if(sValue.indexOf("{}")!=-1){SelectExpression_ThisObj=thisObj;var url=CPWebRootPath+"/Plat/Common/SelectExp?Type="+nType,nHeight=600,nWidth=750,iTop=(window.screen.availHeight-30-nHeight)/2,iLeft=(window.screen.availWidth-10-nWidth)/2,name="新窗口_"+Math.random();window.open(url,"","height="+nHeight+", width="+nWidth+",top="+iTop+",left="+iLeft+", location=yes,menubar=no,resizable=yes,scrollbars=yes,status=no,toolbar=no");return}}function SelectFontIcon(thisObj){SelectFontIcon_ThisObj=thisObj;CPOpenDialog("/Style/AibabaIcon/SelIcon.html","选择图标",1e3,1e3)}function SelectFontIcon_SetReturn(){var obj=$(SelectFontIcon_ThisObj),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldName=obj.attr("data-fieldName"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName");CPFormGlobal_Scope.SetFieldValue(tableName,fieldName,dataTableRowIndex,CPShowModalDialogReturnArgs)}function CPOrganSelectMethod_SetReturn(){if(CPShowModalDialogReturnArgs!=null){var obj=$("#"+CPFormUserSelectMethod_CurControlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldName=obj.attr("data-fieldName"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName");CPFormGlobal_Scope.SetFieldValue(tableName,fieldName,dataTableRowIndex,CPShowModalDialogReturnArgs.UserNames);CPFormGlobal_Scope.SetFieldValue(tableName,fieldValueName,dataTableRowIndex,CPShowModalDialogReturnArgs.UserIds)}}function CPFormUserSelectMethod(controlId,organIsCanMultiSel){var obj=$("#"+controlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName"),url;if(fieldValueName==""){alert("你未配置存储用户ID的字段，请先在字段详细信息里配置存储值的字段！");return}CPOrganSelectPage_SelUserIds=CPFormGlobal_Scope.GetFieldValue(tableName,fieldValueName,dataTableRowIndex);CPFormUserSelectMethod_CurControlId=controlId;url="/Plat/Organ/OrganSel?IsMultiSel="+organIsCanMultiSel;OpenNewModel(url,"选择用户",760,500)}function CPFormDepSelectMethod_SetReturn(){if(CPShowModalDialogReturnArgs!=null){var obj=$("#"+CPFormDepSelectMethod_CurControlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldName=obj.attr("data-fieldName"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName");CPFormGlobal_Scope.SetFieldValue(tableName,fieldName,dataTableRowIndex,CPShowModalDialogReturnArgs.DepNames);CPFormGlobal_Scope.SetFieldValue(tableName,fieldValueName,dataTableRowIndex,CPShowModalDialogReturnArgs.DepIds)}}function CPFormDepSelectMethod(controlId,organIsCanMultiSel){var obj=$("#"+controlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName"),CPDepSelectPage_SelDepIds,url;if(fieldValueName==""){alert("你未配置存储部门ID的字段，请先在字段详细信息里配置存储值的字段！");return}CPDepSelectPage_SelDepIds=CPFormGlobal_Scope.GetFieldValue(tableName,fieldValueName,dataTableRowIndex);CPFormDepSelectMethod_CurControlId=controlId;url="";url=organIsCanMultiSel=="false"?"/Plat/Tree/TreeView?TreeCode=Tree201711041939260006&SelDepIds="+CPDepSelectPage_SelDepIds:"/Plat/Tree/TreeView?TreeCode=Tree201711041918460005&SelDepIds="+CPDepSelectPage_SelDepIds;OpenNewModel(url,"选择部门",550,500)}function CPFormRoleSelectMethod_SetReturn(){if(CPShowModalDialogReturnArgs!=null){var obj=$("#"+CPFormRoleSelectMethod_CurControlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldName=obj.attr("data-fieldName"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName");CPFormGlobal_Scope.SetFieldValue(tableName,fieldName,dataTableRowIndex,CPShowModalDialogReturnArgs.RoleNames);CPFormGlobal_Scope.SetFieldValue(tableName,fieldValueName,dataTableRowIndex,CPShowModalDialogReturnArgs.RoleIds)}}function CPFormRoleSelectMethod(controlId,organIsCanMultiSel){var obj=$("#"+controlId),dataTableRowIndex=obj.attr("data-dataTableRowIndex"),fieldValueName=obj.attr("data-fieldValueName"),tableName=obj.attr("data-tableName"),CPRoleSelectPage_SelRoleIds,url;if(fieldValueName==""){alert("你未配置存储角色ID的字段，请先在字段详细信息里配置存储值的字段！");return}CPRoleSelectPage_SelRoleIds=CPFormGlobal_Scope.GetFieldValue(tableName,fieldValueName,dataTableRowIndex);CPFormRoleSelectMethod_CurControlId=controlId;url="";url=organIsCanMultiSel=="false"?"/Plat/Grid/GridView?GridCode=Grid201711042006440020":"/Plat/Grid/GridView?GridCode=Grid201711041956490019";OpenNewModel(url,"选择角色",650,500)}function CPFormRoleSelectMethodForAllRole_SetReturn(){CPShowModalDialogReturnArgs!=null&&(CPFormGlobal_Scope.SetFieldValue(CPFormRoleSelectMethodForAllRole_tableName,CPFormRoleSelectMethodForAllRole_fieldName,CPFormRoleSelectMethodForAllRole_dataTableRowIndex,CPShowModalDialogReturnArgs.RoleNames),CPFormGlobal_Scope.SetFieldValue(CPFormRoleSelectMethodForAllRole_tableName,CPFormRoleSelectMethodForAllRole_fieldValueName,CPFormRoleSelectMethodForAllRole_dataTableRowIndex,CPShowModalDialogReturnArgs.RoleIds))}function CPFormRoleSelectMethodForAllRole(tableName,fieldName,fieldValueName,dataTableRowIndex,organIsCanMultiSel){CPFormRoleSelectMethodForAllRole_tableName=tableName;CPFormRoleSelectMethodForAllRole_fieldName=fieldName;CPFormRoleSelectMethodForAllRole_fieldValueName=fieldValueName;CPFormRoleSelectMethodForAllRole_dataTableRowIndex=dataTableRowIndex;var CPRoleSelectPage_SelRoleIds=CPFormGlobal_Scope.GetFieldValue(tableName,fieldValueName,dataTableRowIndex),url="";url=organIsCanMultiSel=="false"?"/Plat/Grid/GridView?GridCode=Grid201805230710410033":"/Plat/Grid/GridView?GridCode=Grid201805230710410033";OpenNewModel(url,"选择角色",800,700)}function CPFormUpdateConfig(formId){var url="/Plat/Tab/TabView?TabCode=Tab0003&DeviceType=1&SysId=1&TargetFormId="+formId;try{top.OpenNewModel(url,"修改配置",9e3,9e3)}catch(e){OpenNewModel(url,"修改配置",9e3,9e3)}}var CPFormGlobal_FormCode=$.CPGetQuery("FormCode"),CPFormGlobal_SceneCode,CPFormGlobal_ViewCode,CPFormGlobal_InitGroupCode,CPFormGlobal_RightGroupCode,CPFormGlobal_PKValues,CPFormGlobal_IsView,CPFormGlobal_DeviceType,CPFormGlobal_FormUseInCPFlow,SelectExpression_ThisObj,SelectFontIcon_ThisObj,CPFormUserSelectMethod_CurControlId,CPOrganSelectPage_SelUserIds,CPFormDepSelectMethod_CurControlId,CPFormRoleSelectMethod_CurControlId,CPFormRoleSelectMethodForAllRole_tableName,CPFormRoleSelectMethodForAllRole_fieldName,CPFormRoleSelectMethodForAllRole_fieldValueName,CPFormRoleSelectMethodForAllRole_dataTableRowIndex;(CPFormGlobal_FormCode==null||CPFormGlobal_FormCode==undefined)&&(CPFormGlobal_FormCode="");CPFormGlobal_SceneCode=$.CPGetQuery("SceneCode");(CPFormGlobal_SceneCode==null||CPFormGlobal_SceneCode==undefined)&&(CPFormGlobal_SceneCode="");CPFormGlobal_ViewCode=$.CPGetQuery("ViewCode");(CPFormGlobal_ViewCode==null||CPFormGlobal_ViewCode==undefined)&&(CPFormGlobal_ViewCode="");CPFormGlobal_InitGroupCode=$.CPGetQuery("InitGroupCode");(CPFormGlobal_InitGroupCode==null||CPFormGlobal_InitGroupCode==undefined)&&(CPFormGlobal_InitGroupCode="");CPFormGlobal_RightGroupCode=$.CPGetQuery("RightGroupCode");(CPFormGlobal_RightGroupCode==null||CPFormGlobal_RightGroupCode==undefined)&&(CPFormGlobal_RightGroupCode="");CPFormGlobal_PKValues=$.CPGetQuery("PKValues");(CPFormGlobal_PKValues==null||CPFormGlobal_PKValues==undefined)&&(CPFormGlobal_PKValues="");CPFormGlobal_IsView=$.CPGetQuery("IsView");(CPFormGlobal_IsView==null||CPFormGlobal_IsView==undefined)&&(CPFormGlobal_IsView="false");CPFormGlobal_DeviceType=$.CPGetQuery("DeviceType");(CPFormGlobal_DeviceType==null||CPFormGlobal_DeviceType==undefined)&&(CPFormGlobal_DeviceType="1");CPFormGlobal_FormUseInCPFlow=$.CPGetQuery("FormUseInCPFlow");(CPFormGlobal_FormUseInCPFlow==null||CPFormGlobal_FormUseInCPFlow==undefined)&&(CPFormGlobal_FormUseInCPFlow="false");var CPFormGlobal_Scope=null,CPFormGlobal_FormObj={},CPFormGlobal_CurControlDataRowIndex=0;angular.module("CPFormEngineApp",[]).controller("MyCtrl",function($scope,$sce,$http){var formUrl=CPWebRootPath+"/api/FormEngine/GetFormInfo?FormCode="+CPFormGlobal_FormCode+"&SceneCode="+CPFormGlobal_SceneCode+"&ViewCode="+CPFormGlobal_ViewCode+"&InitGroupCode="+CPFormGlobal_InitGroupCode+"&RightGroupCode="+CPFormGlobal_RightGroupCode+"&PKValues="+CPFormGlobal_PKValues+"&CurUserId="+CPCurUserId+"&CurUserIden="+CPCurUserIden+"&DeviceType="+CPFormGlobal_DeviceType,sResultArray,mm,tempSarray;for(formUrl+="&IsView="+CPFormGlobal_IsView,sResultArray=CPGetQueryString(),mm=0;mm<sResultArray.length;mm++)(tempSarray=sResultArray[mm].split("="),tempSarray[0].toLowerCase()!="formcode"&&tempSarray[0].toLowerCase()!="scenecode"&&tempSarray[0].toLowerCase()!="viewcode"&&tempSarray[0].toLowerCase()!="initgroupcode"&&tempSarray[0].toLowerCase()!="rightgroupcode"&&tempSarray[0].toLowerCase()!="pkvalues"&&tempSarray[0].toLowerCase()!="curuserid"&&tempSarray[0].toLowerCase()!="curuseriden"&&tempSarray[0].toLowerCase()!="devicetype"&&tempSarray[0].toLowerCase()!="isview")&&(formUrl+="&"+sResultArray[mm]);$(window).width()<$("#CPFormContainer").width()&&$("#CPFormContainer").width($(window).width()-50);$http.get(formUrl).then(function(data){if(data.data.Result==!1)return alert(data.data.ErrorMsg),!1;console.log(data);CPFormGlobal_FormObj.Config=data.data.Form;CPFormGlobal_FormObj.Config.UseSceneCol[0].FormScript!=null&&CPFormGlobal_FormObj.Config.UseSceneCol[0].FormScript!=""&&$("#divCPFormJSContainer").html(CPFormGlobal_FormObj.Config.UseSceneCol[0].FormScript);CPFormGlobal_FormObj.FormHtml=data.data.ViewHTML;var tmpObj=JSON.parse(data.data.FormDataJSON);tmpObj[CPFormGlobal_FormObj.Config.MainTableName]=JSON.parse(tmpObj[CPFormGlobal_FormObj.Config.MainTableName]);tmpObj[CPFormGlobal_FormObj.Config.MainTableName]=tmpObj[CPFormGlobal_FormObj.Config.MainTableName][0];CPFormGlobal_FormObj.Config.ChildTableCol!=undefined&&CPFormGlobal_FormObj.Config.ChildTableCol!=null&&$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nIndex,nObj){tmpObj[nObj.TableName]=JSON.parse(tmpObj[nObj.TableName]);tmpObj[nObj.TableName+"_ExtendTableInitValue"]!=undefined&&tmpObj[nObj.TableName+"_ExtendTableInitValue"]!=null&&(tmpObj[nObj.TableName+"_ExtendTableInitValue"]=JSON.parse(tmpObj[nObj.TableName+"_ExtendTableInitValue"]))});$.each(CPFormGlobal_FormObj.Config.FieldCol,function(nIndex,nObj){(nObj.ControlType==3||nObj.ControlType==4||nObj.ControlType==5||nObj.ControlType==6)&&(tmpObj[nObj.TableName+"_"+nObj.FieldName]=JSON.parse(tmpObj[nObj.TableName+"_"+nObj.FieldName]))});tmpObj[CPFormGlobal_FormObj.Config.MainTableName].CPFormDataIndex=0;CPFormGlobal_FormObj.Config.ChildTableCol!=undefined&&CPFormGlobal_FormObj.Config.ChildTableCol!=null&&$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nIndex,nObj){$.each(tmpObj[nObj.TableName],function(nDataIndex,nDataObj){nDataObj.CPFormDataIndex=nDataIndex})});CPFormGlobal_FormObj.Data=tmpObj;$scope.CPFormInitButton();$scope.FormObj=CPFormGlobal_FormObj;$scope.$watch("$viewContentLoaded",function(){CPFormGlobal_FormObj.Config.UseSceneCol[0].FormLoadExJSMethod!=null&&CPFormGlobal_FormObj.Config.UseSceneCol[0].FormLoadExJSMethod!=""&&eval(CPFormGlobal_FormObj.Config.UseSceneCol[0].FormLoadExJSMethod)})});$scope.CPFormInitButton=function(){if(CPFormGlobal_FormObj.Config.UseSceneCol.length<=0)return alert("请传入使用场景参数"),!1;var sHtml="";$.each(CPFormGlobal_FormObj.Config.UseSceneCol[0].FuncCol,function(nIndex,nObj){sHtml+='<button onclick="'+nObj.FuncExeJS+'" class="layui-btn layui-btn-normal">'+nObj.FuncTitle+"<\/button>"});$("#CPFormButton").html(sHtml)};$scope.CPFormAddChildRow=function(btnId,isClickButton){var exTableName=$("#"+btnId).attr("data-TableName"),nObj={},relateFieldName="",maxCPFormDataIndex,sourceRowValue,item,objDT;$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nIndex,nObj){if(nObj.TableName==exTableName){relateFieldName=nObj.RelateFieldName;return}});maxCPFormDataIndex=0;$.each(CPFormGlobal_FormObj.Data[exTableName],function(nIndex,nObj){nObj.CPFormDataIndex>maxCPFormDataIndex&&(maxCPFormDataIndex=nObj.CPFormDataIndex)});sourceRowValue=CPFormGlobal_FormObj.Data[exTableName][CPFormGlobal_FormObj.Data[exTableName].length-1];for(item in sourceRowValue)item!="$$hashKey"&&(item==relateFieldName?nObj[item]=sourceRowValue[item]:item=="CPFormDataIndex"?nObj.CPFormDataIndex=maxCPFormDataIndex+1:(objDT=CPFormGlobal_FormObj.Data[exTableName+"_ExtendTableInitValue"],nObj[item]=objDT!=undefined&&objDT!=null&&objDT.length>0?objDT[0][item]:""));CPFormGlobal_FormObj.Data[exTableName].push(nObj);isClickButton==!1&&$scope.$applyAsync()};$scope.CPFormDelChildRow=function(CPFormDataIndex,tableName){if(CPFormGlobal_FormObj.Data[tableName].length<=1){alert("至少得留一行，不能删除了！");return}var removeIndex=-1;$.each(CPFormGlobal_FormObj.Data[tableName],function(nIndex,nObj){if(Number(nObj.CPFormDataIndex)==Number(CPFormDataIndex)){removeIndex=nIndex;return}});CPFormGlobal_FormObj.Data[tableName].splice(removeIndex,1);$scope.$applyAsync();$scope.SetFormDivContainerHeight()};$scope.SetFormDivContainerHeight=function(){if(CPFormGlobal_FormUseInCPFlow!="true"){var nHeight=$(window).height();nHeight=nHeight-$("#CPFormButton").height()-25;nHeight<$("#CPFormMain").height()&&$("#CPFormMain").height(nHeight)}else $(document.body).css("overflow","auto")};$scope.SetCheckBoxFieldChecked=function(fieldValue,curChkValue){if(fieldValue==null||fieldValue=="")return!1;var sArray=fieldValue.split(",");return $.inArray(curChkValue,sArray)==-1?!1:!0};$scope.SetRadioFieldChecked=function(fieldValue,curChkValue){return fieldValue==null||curChkValue==null?!1:fieldValue==curChkValue?!0:!1};$scope.SetCheckBoxFieldValue=function(isExtendTable,extendTableDataIndex,tableName,fieldName,formFieldId){var sValue=$(event.target).val(),isChecked=event.target.checked,sOldValue="",tmpArray,needAdd,i,sArray,sOldValue2;if(isExtendTable=="true")$.each(CPFormGlobal_FormObj.Data[tableName],function(nIndex,nObj){var tmpArray,needAdd,i;if(Number(nObj.CPFormDataIndex)==Number(extendTableDataIndex)){if(sOldValue=nObj[fieldName],(sOldValue==!0||sOldValue==!1)&&(sOldValue=""),tmpArray=sOldValue.split(","),isChecked){for(needAdd=!0,i=0;i<tmpArray.length;i++)tmpArray[i]==sValue&&(needAdd=!1);needAdd&&(sOldValue==""?sOldValue=sValue:sOldValue+=","+sValue)}else for(sOldValue="",i=0;i<tmpArray.length;i++)tmpArray[i]!=sValue&&(sOldValue==""?sOldValue=tmpArray[i]:sOldValue+=","+tmpArray[i]);nObj[fieldName]=sOldValue}});else{if(sOldValue=CPFormGlobal_FormObj.Data[tableName][fieldName],(sOldValue==!0||sOldValue==!1)&&(sOldValue=""),tmpArray=sOldValue.split(","),isChecked){for(needAdd=!0,i=0;i<tmpArray.length;i++)tmpArray[i]==sValue&&(needAdd=!1);needAdd&&(sOldValue==""?sOldValue=sValue:sOldValue+=","+sValue)}else for(sOldValue="",i=0;i<tmpArray.length;i++)tmpArray[i]!=sValue&&(sOldValue==""?sOldValue=tmpArray[i]:sOldValue+=","+tmpArray[i]);CPFormGlobal_FormObj.Data[tableName][fieldName]=sOldValue}sArray=$("input[name='CPForm_"+formFieldId+"']");sOldValue2=","+sOldValue+",";$.each(sArray,function(nIndex,nObj){sOldValue2.indexOf(","+$(nObj).val()+",")==-1?$(nObj).prop("checked",!1):$(nObj).prop("checked",!0)})};$scope.SetComboxSkinIsExecute=!1;$scope.SetComboxSkin=function(){$scope.SetComboxSkinIsExecute!=!0&&$(".comboxwrapper").each(function(){$scope.SetComboxSkinIsExecute=!0;$(this).children(".comboxinput-wrapper").click(function(event){content=$(this).parent().children(".comboxcontent");var inputObj=$(this).children("input");if($(inputObj).attr("readonly")!="readonly"){if(event.stopPropagation(),content.css("display")=="none"){$(".comboxcontent").each(function(){$(this).hide();$(this).css("opacity","0");$(this).css("top","84px");$(".comboxinput-wrapper").children("img").css("transform","rotate(0deg)")});content.show();$(this).children("img").css("transform","rotate(180deg)");setTimeout(myAnimate1,100);function myAnimate1(){content.css("opacity","1");content.css("top","34px")}}else{content.css("opacity","0");content.css("top","84px");$(".comboxinput-wrapper").children("img").css("transform","rotate(0deg)");setTimeout(myAnimate2,100);function myAnimate2(){content.hide()}}$(document).click(function(){function myAnimate2(){content.hide()}content.css("opacity","0");content.css("top","84px");$(".comboxinput-wrapper").children("img").css("transform","rotate(0deg)");setTimeout(myAnimate2,100)});content.click(function(event){event.stopPropagation()})}});$(this).children(".comboxcontent").children("li").each(function(){$(this).click(function(){function myAnimate3(){$(".comboxcontent").hide()}var inputObj=$(this).parent().parent().children(".comboxinput-wrapper").children("input");inputObj.val($(this).html());var ngModel=inputObj.attr("ng-model"),datatablerowindex=inputObj.attr("data-datatablerowindex"),sArray=ngModel.split("."),bExtendTableField=!1;$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nTableIndex,nTableObj){if(nTableObj.TableName==sArray[2]){bExtendTableField=!0;return}});bExtendTableField?CPFormGlobal_FormObj.Data[sArray[2]][datatablerowindex][sArray[3]]=$(this).html():CPFormGlobal_FormObj.Data[sArray[2]][sArray[3]]=$(this).html();$(this).parent().children("li").removeClass("active");$(this).addClass("active");$(".comboxinput-wrapper").children("img").css("transform","rotate(0deg)");$(this).parent().css("opacity","0");$(this).parent().css("top","84px");setTimeout(myAnimate3,100)})})})};$scope.CheckData=function(){var errorMsg="";return $.each(CPFormGlobal_FormObj.Config.FieldCol,function(nIndex,nObjField){var bExtendTableField,ExtendTableObj,sTip,sValue;nObjField.IsChildTable||(bExtendTableField=!1,ExtendTableObj=null,$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nTableIndex,nTableObj){if(nTableObj.TableName==nObjField.TableName){ExtendTableObj=nTableObj;bExtendTableField=!0;return}}),sTip="",sTip=nObjField.NotAllowNullTip==null||nObjField.NotAllowNullTip==""?nObjField.FieldTitle+"不允许为空":nObjField.NotAllowNullTip,bExtendTableField==!1?nObjField.FieldName!=CPFormGlobal_FormObj.Config.PKFieldName&&nObjField.IsAllowNull==!1&&(sValue=CPFormGlobal_FormObj.Data[CPFormGlobal_FormObj.Config.MainTableName][nObjField.FieldName],sValue==""&&(errorMsg==""?errorMsg=sTip:errorMsg+="\n"+sTip)):$.each(CPFormGlobal_FormObj.Data[ExtendTableObj.TableName],function(nCDataIndex,nCDataObj){if(nObjField.FieldName!=ExtendTableObj.PKFieldName&&nObjField.FieldName!=ExtendTableObj.RelateFieldName&&nObjField.IsAllowNull==!1){var sValue=nCDataObj[nObjField.FieldName];sValue==""&&(errorMsg==""?errorMsg=sTip:errorMsg+="\n"+sTip)}}))}),$.each(CPFormGlobal_FormObj.Config.FieldRuleCol,function(nIndex,nObj){var sCondition,fieldObj,render,sValue;nObj.RuleType==1&&(sCondition=nObj.RuleCondition,sCondition.indexOf("[index]")!=-1?(fieldObj=$scope.GetFieldObj(nObj.FieldId),$.each(CPFormGlobal_FormObj.Data[fieldObj.TableName],function(nDataIndex,nDataObj){var dataTableRowIndex=nDataObj.CPFormDataIndex,render,sValue;for(sCondition=nObj.RuleCondition;sCondition.indexOf("[index]")!=-1;)sCondition=sCondition.replace("[index]","["+dataTableRowIndex+"]");render=template.compile(sCondition);sValue=render(CPFormGlobal_FormObj.Data);sValue=CPTrim(sValue);sValue.toLowerCase()=="false"&&(errorMsg==""?errorMsg=nObj.RuleTargetOpertion:errorMsg+="\n"+nObj.RuleTargetOpertion)})):(render=template.compile(sCondition),sValue=render(CPFormGlobal_FormObj.Data),sValue=CPTrim(sValue),sValue.toLowerCase()=="false"&&(errorMsg==""?errorMsg=nObj.RuleTargetOpertion:errorMsg+="\n"+nObj.RuleTargetOpertion)))}),errorMsg!=""?(alert(errorMsg),!1):!0};$scope.GetFieldObj=function(fieldId){var nTmpObj;return $.each(CPFormGlobal_FormObj.Config.FieldCol,function(nIndex,nObj){if(nObj.Id==fieldId){nTmpObj=nObj;return}}),nTmpObj};$scope.IsExtendTable=function(tableName){return CPFormGlobal_FormObj.Config.MainTableName.toLocaleLowerCase()==tableName.toLocaleLowerCase()?!1:!0};$scope.SaveFormData=function(){var sB,url,formData,obj;if(($("#divLoading").show(),$scope.CheckData()==!1)||CPFormGlobal_FormObj.Config.UseSceneCol[0].BeforeFormClientSave!=""&&(sB=eval(CPFormGlobal_FormObj.Config.UseSceneCol[0].BeforeFormClientSave),sB==!1))return $("#divLoading").hide(),CPFormGlobal_FormUseInCPFlow=="true"&&parent.CPFlowAfterFormSaveError(),!1;url=CPWebRootPath+"/api/FormEngine/SaveFormData?"+window.location.search;formData={};formData[CPFormGlobal_FormObj.Config.MainTableName]=CPFormGlobal_FormObj.Data[CPFormGlobal_FormObj.Config.MainTableName];CPFormGlobal_FormObj.Config.ChildTableCol!=undefined&&CPFormGlobal_FormObj.Config.ChildTableCol!=null&&$.each(CPFormGlobal_FormObj.Config.ChildTableCol,function(nIndex,nObj){formData[nObj.TableName]=CPFormGlobal_FormObj.Data[nObj.TableName]});obj={};obj.CurUserId=CPCurUserId;obj.CurUserIden=CPCurUserIden;obj.FormCode=CPFormGlobal_FormCode;obj.PKValue=CPFormGlobal_PKValues;obj.SceneCode=CPFormGlobal_SceneCode;obj.FormDataJSON=JSON.stringify(formData);$http.post(url,obj).then(function(data){if(data.data.Result==!1)return alert(data.data.ErrorMsg),CPFormGlobal_FormUseInCPFlow=="true"&&parent.CPFlowAfterFormSaveError(),!1;CPFormGlobal_FormUseInCPFlow=="false"&&alert("保存成功！");$("#divLoading").hide();$scope.AfterSaveFormData(data.data.PKValues)})};$scope.AfterSaveFormData=function(PKValues){var insTitle,url;if(CPFormGlobal_FormUseInCPFlow=="true")try{insTitle=$scope.GetFieldValue(CPFormGlobal_FormObj.Form.MainTableName,"FlowTitle",0);insTitle!=null&&insTitle!=undefined&&insTitle!=""?parent.CPFlowAfterFormSaveSuccess(PKValues,insTitle):parent.CPFlowAfterFormSaveSuccess(PKValues,"")}catch(e){parent.CPFlowAfterFormSaveSuccess(PKValues,"")}else CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==1?window.close():CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==2?parent.CloseNewModel():CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==3?CPFormGlobal_PKValues==""&&(url=window.location.href,url+="&PKValues="+PKValues,window.location.href=url):CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==4?window.location.href=CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedInfo:CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==5?eval(CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedInfo):CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==6?top.CloseNewModel():CPFormGlobal_FormObj.Config.UseSceneCol[0].FormSavedAction==7&&(parent.CPTreeRefresh(),CPFormGlobal_PKValues==""&&(url=window.location.href,url+="&PKValues="+PKValues,window.location.href=url))};$scope.SetTimeSelControlIsExecute=!1;$scope.SetTimeSelControl=function(){if(!$scope.SetTimeSelControlIsExecute){var nArray=$(".layerTimeSel"),laydate=layui.laydate;$.each(nArray,function(nIndex,nObj){var layerUIInnerType=$(nObj).attr("data-layerUIInnerType");$(nObj).attr("readonly")!="readonly"&&(layerUIInnerType!=""?laydate.render({elem:"#"+$(nObj).attr("id"),type:layerUIInnerType,done:function(value){$scope.SetFieldValue($(nObj).attr("data-tablename"),$(nObj).attr("data-fieldname"),$(nObj).attr("data-datatablerowindex"),value)}}):laydate.render({elem:"#"+$(nObj).attr("id"),format:$(nObj).attr("data-timeFormat"),done:function(value){$scope.SetFieldValue($(nObj).attr("data-tablename"),$(nObj).attr("data-fieldname"),$(nObj).attr("data-datatablerowindex"),value)}}))});$scope.SetTimeSelControlIsExecute=!0}};$scope.bExtendTableContextMenuIsCreated=!1;$scope.$on("ngRepeatFinished",function(){$scope.SetFormDivContainerHeight();try{$scope.bExtendTableContextMenuIsCreated==!1&&($.contextMenu({selector:".CPFormExtendTableTdCss",trigger:"right",callback:function(key){var datatablerowindex=$(CPForm_ContenxtMenuClickTarget).attr("data-datatablerowindex"),tableName=$(CPForm_ContenxtMenuClickTarget).attr("data-tableName"),array;if((datatablerowindex==undefined||datatablerowindex==null)&&(array=$("input[data-datatablerowindex]",$(CPForm_ContenxtMenuClickTarget).parent().parent()),array.length>0?(datatablerowindex=$(array[0]).attr("data-datatablerowindex"),tableName=$(array[0]).attr("data-tableName")):(array=$("select[data-datatablerowindex]",$(CPForm_ContenxtMenuClickTarget).parent().parent()),array.length>0&&(datatablerowindex=$(array[0]).attr("data-datatablerowindex"),tableName=$(array[0]).attr("data-tableName")))),datatablerowindex==undefined||datatablerowindex==null){alert("未获取到datatablerowindex索引值");return}key=="delete"?$("#btnCPFormAddChildRow_"+tableName).length<=0?alert("您无数据删除的权限，请联系管理员！"):$scope.CPFormDelChildRow(datatablerowindex,tableName):key=="add"&&($("#btnCPFormAddChildRow_"+tableName).length<=0?alert("您无数据添加的权限，请联系管理员！"):$scope.CPFormAddChildRow("btnCPFormAddChildRow_"+tableName,!1))},items:{add:{name:"添加新行",icon:"edit"},"delete":{name:"删除此行",icon:"delete"}}}),$scope.bExtendTableContextMenuIsCreated=!0)}catch(e){}$("#divLoading").hide();$("#CPFormContainer").show();CPFormGlobal_FormUseInCPFlow!="true"&&$("#CPFormButton").show();$scope.SetComboxSkin();$scope.SetTimeSelControl()});$scope.GetFieldId=function(tableName,fieldName){var id="";return $.each(CPFormGlobal_FormObj.Config.FieldCol,function(nIndex,nObj){if(nObj.FieldName.toLowerCase()==fieldName.toLowerCase()&&nObj.TableName.toLowerCase()==tableName.toLowerCase()){id=nObj.Id;return}}),id};$scope.CPFormChange=function(fieldId,controlId,onchangeExMethod){var dataTableRowIndex=$("#"+controlId).attr("data-dataTableRowIndex");CPFormGlobal_CurControlDataRowIndex=dataTableRowIndex;$.each(CPFormGlobal_FormObj.Config.FieldRuleCol,function(nIndex,nObj){var sCondition,dataTableRowIndex,renderNew,sValueNew,render,sValue,arrayT,disableFieldId;if(fieldId==nObj.FieldId){for(sCondition=nObj.RuleCondition;sCondition.indexOf("[index]")!=-1;)sCondition=sCondition.replace("[index]","["+dataTableRowIndex+"]");if(nObj.RuleType==3){if(render=template.compile(sCondition),sValue=render(CPFormGlobal_FormObj.Data),sValue=CPTrim(sValue),sValue.toLowerCase()=="true"){for(sCondition=nObj.RuleTargetOpertion,dataTableRowIndex=$("#"+controlId).attr("data-dataTableRowIndex");sCondition.indexOf("[index]")!=-1;)sCondition=sCondition.replace("[index]","["+dataTableRowIndex+"]");renderNew=template.compile(sCondition);sValueNew=renderNew(CPFormGlobal_FormObj.Data)}}else nObj.RuleType==2&&(render=template.compile(sCondition),sValue=render(CPFormGlobal_FormObj.Data),sValue=CPTrim(sValue),nObj.RuleTargetOpertion!=""&&(arrayT=nObj.RuleTargetOpertion.split("."),arrayT.length>=2&&(disableFieldId=$scope.GetFieldId(arrayT[0],arrayT[1]),disableFieldId!=""&&($scope.IsExtendTable(arrayT[0])?sValue.toLowerCase()=="true"?$("#CPForm_"+disableFieldId+"_"+dataTableRowIndex).attr("disabled","disabled"):$("#CPForm_"+disableFieldId+"_"+dataTableRowIndex).removeAttr("disabled"):sValue.toLowerCase()=="true"?$("#CPForm_"+disableFieldId).attr("disabled","disabled"):$("#CPForm_"+disableFieldId).removeAttr("disabled")))))}});onchangeExMethod!=undefined&&onchangeExMethod!=null&&onchangeExMethod!=""&&eval(onchangeExMethod)};$scope.GetFieldValue=function(tableName,fieldName,CPFormDataIndex){return $scope.IsExtendTable(tableName)?CPFormGlobal_FormObj.Data[tableName][CPFormDataIndex][fieldName]:CPFormGlobal_FormObj.Data[tableName][fieldName]};$scope.SetFieldValue=function(tableName,fieldName,CPFormDataIndex,sValue){$scope.IsExtendTable(tableName)?CPFormGlobal_FormObj.Data[tableName][CPFormDataIndex][fieldName]=sValue:CPFormGlobal_FormObj.Data[tableName][fieldName]=sValue;$scope.$applyAsync()};$scope.FileUploadInfoReturnArray=function(sValue){return sValue.split(",")};$scope.UploadNewFile=function(tableName,fileNameField,filePathField,CPFormDataIndex,FileAllowType,FileAllowCount){var ReturnMethod="CPFormGlobal_Scope.UploadNewFile_SetReturn('"+tableName+"','"+fileNameField+"','"+filePathField+"',"+CPFormDataIndex+")",url=CPWebRootPath+"/Plat/Common/FileUpload?BusinessCode="+CPFormGlobal_FormObj.Config.FormCode+"&ReturnMethod="+escape(ReturnMethod);url+="&AllowFileTypes="+escape(FileAllowType)+"&AllowFileCount="+FileAllowCount;CPOpenDialog(url,"上传附件",600,400)};$scope.UploadNewFile_SetReturn=function(tableName,fileNameField,filePathField,CPFormDataIndex){var names=$scope.GetFieldValue(tableName,fileNameField,CPFormDataIndex),paths;names!=""?names+=","+CPShowModalDialogReturnArgs.FileNames:names=CPShowModalDialogReturnArgs.FileNames;paths=$scope.GetFieldValue(tableName,filePathField,CPFormDataIndex);paths!=""?paths+="|"+CPShowModalDialogReturnArgs.FilePaths:paths=CPShowModalDialogReturnArgs.FilePaths;$scope.SetFieldValue(tableName,fileNameField,CPFormDataIndex,names);$scope.SetFieldValue(tableName,filePathField,CPFormDataIndex,paths)};$scope.ViewAttachFile=function(filePath){var url=CPWebRootPath+"/api/CPCommonEngine/DownloadFile?FilePath="+escape(filePath);window.location.href=url};$scope.DelAttachFile=function(tableName,fileNameField,filePathField,CPFormDataIndex,filePath){var names=$scope.GetFieldValue(tableName,fileNameField,CPFormDataIndex),paths=$scope.GetFieldValue(tableName,filePathField,CPFormDataIndex),nameArray=names.split(","),pathArray=paths.split("|"),i;for(names="",paths="",i=0;i<pathArray.length;i++)filePath!=pathArray[i]&&(paths==""?(paths=pathArray[i],names=nameArray[i]):(paths+="|"+pathArray[i],names+=","+nameArray[i]));$scope.SetFieldValue(tableName,fileNameField,CPFormDataIndex,names);$scope.SetFieldValue(tableName,filePathField,CPFormDataIndex,paths)};$scope.RoleSelectMethod=function(organIsCanMultiSel){var controlId=$(event.target).attr("data-ControlId");CPFormRoleSelectMethod(controlId,organIsCanMultiSel)};$scope.UserSelectMethod=function(organIsCanMultiSel){var controlId=$(event.target).attr("data-ControlId");CPFormUserSelectMethod(controlId,organIsCanMultiSel)};$scope.DepSelectMethod=function(organIsCanMultiSel){var controlId=$(event.target).attr("data-ControlId");CPFormDepSelectMethod(controlId,organIsCanMultiSel)};CPFormGlobal_Scope=$scope}).filter("to_trusted",["$sce",function($sce){return function(text){return $sce.trustAsHtml(text)}}]).filter("SplitStringToArray",function(){return function(text){return text==""?null:text.split("|")}}).filter("ListRelateFilterMethod",function(){return function(text,tableName,ListRelateTargetField){if(ListRelateTargetField!=""){if(CPFormGlobal_Scope.IsExtendTable(tableName))return alert("下拉列表暂时不支持在子表中使用！"),text;var mValue=CPFormGlobal_Scope.GetFieldValue(tableName,ListRelateTargetField,0),sArray=[];return $.each(text,function(nIndex,nObj){nObj.listRelateEx==mValue&&sArray.push(nObj)}),sArray}return text}}).filter("ShowFileName",function(){return function(text){if(text=="")return"";var array=text.split("/");return array[array.length-1]}}).directive("ionicstringtohtml",["$compile",function($compile){return function(scope,element,attrs){scope.$watch(function(scope){return scope.$eval(attrs.inputstring)},function(value){element.html(value);$compile(element.contents())(scope)})}}]).directive("onRepeatFinishedRender",function($timeout){return{restrict:"A",link:function(scope,element){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinished",element)},100)}}});layui.use("laydate",function(){});CPOrganSelectPage_SelUserIds=""